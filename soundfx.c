#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#ifndef SDL_MAIN_HANDLED
#define SDL_MAIN_HANDLED
#endif
#include <SDL.h>

#include "soundfx.h"
#include "invfreq.h"

SDL_AudioDeviceID g_audio_dev;

uint16_t got_trophy[8 * 32] = {
    0x0BF4, 0x0BF4, 0x0BF4, 0x0BF4, 0x0BB8, 0x0BB8, 0x0B7C, 0x0B7C,
    0x0B40, 0x0B40, 0x0B40, 0x0B04, 0x0B04, 0x0B04, 0x0B04, 0x0AC8,
    0x0AC8, 0x0AC8, 0x0AC8, 0x0AC8, 0x0AC8, 0x0B04, 0x0B04, 0x0B04,
    0x0B04, 0x0B40, 0x0B7C, 0x0B7C, 0x0BB8, 0x0BB8, 0x0C30, 0x0C6C,
    0x0CA8, 0x0CE4, 0x0CE4, 0x0CE4, 0x0D20, 0x0D20, 0x0D20, 0x0D20,
    0x0D20, 0x0D20, 0x0D20, 0x0D20, 0x0D20, 0x0D20, 0x0CE4, 0x0CE4,
    0x0C6C, 0x0C6C, 0x0C30, 0x0BF4, 0x0B7C, 0x0B7C, 0x0B04, 0x0AC8,
    0x0A8C, 0x0A50, 0x0A14, 0x0A14, 0x099C, 0x099C, 0x0960, 0x0924,
    0x0924, 0x08E8, 0x08AC, 0x08AC, 0x0870, 0x0870, 0x0834, 0x0834,
    0x07F8, 0x07F8, 0x07BC, 0x07BC, 0x07BC, 0x07BC, 0x07BC, 0x0780,
    0x0780, 0x0780, 0x0780, 0x0780, 0x0780, 0x0780, 0x0780, 0x0780,
    0x0780, 0x0780, 0x0780, 0x07BC, 0x07BC, 0x07BC, 0x07F8, 0x0834,
    0x0870, 0x08AC, 0x0924, 0x0960, 0x0A14, 0x0A50, 0x0B04, 0x0B40,
    0x0BB8, 0x0BF4, 0x0C30, 0x0C6C, 0x0CA8, 0x0CE4, 0x0D20, 0x0D5C,
    0x0D98, 0x0DD4, 0x0DD4, 0x0E10, 0x0E10, 0x0E10, 0x0E4C, 0x0E4C,
    0x0E4C, 0x0E4C, 0x0E4C, 0x0E4C, 0x0E4C, 0x0E4C, 0x0E4C, 0x0E10,
    0x0DD4, 0x0DD4, 0x0D98, 0x0D5C, 0x0CE4, 0x0CA8, 0x0C6C, 0x0C6C,
    0x0C30, 0x0BF4, 0x0BF4, 0x0BF4, 0x0BB8, 0x0BB8, 0x0BB8, 0x0B40,
    0x0B40, 0x0B40, 0x0B40, 0x0B40, 0x0B40, 0x0B40, 0x0B40, 0x0B40,
    0x0B7C, 0x0B7C, 0x0B7C, 0x0B7C, 0x0B7C, 0x0BB8, 0x0BF4, 0x0BF4,
    0x0BF4, 0x0C30, 0x0C6C, 0x0C6C, 0x0CA8, 0x0CA8, 0x0D20, 0x0D5C,
    0x0DD4, 0x0E10, 0x0E4C, 0x0EC4, 0x0F3C, 0x0FB4, 0x1068, 0x10A4,
    0x111C, 0x1194, 0x11D0, 0x1248, 0x12C0, 0x12FC, 0x1374, 0x13B0,
    0x1428, 0x1464, 0x14A0, 0x14DC, 0x14DC, 0x1518, 0x1518, 0x1518,
    0x1518, 0x1518, 0x14DC, 0x14DC, 0x1464, 0x1464, 0x1428, 0x13EC,
    0x13EC, 0x13EC, 0x13B0, 0x13B0, 0x1374, 0x1374, 0x1374, 0x1374,
    0x1338, 0x1338, 0x1338, 0x1338, 0x1338, 0x1338, 0x1338, 0x1338,
    0x1338, 0x1338, 0x1338, 0x1338, 0x1338, 0x1338, 0x1338, 0x1338,
    0x1338, 0x1338, 0x1338, 0x1338, 0x13B0, 0x13B0, 0x13EC, 0x13EC,
    0x1464, 0x1428, 0x14A0, 0x14A0, 0x14DC, 0x1518, 0x1590, 0x15CC,
    0x1644, 0x16F8, 0x1770, 0x17AC, 0x1860, 0x189C, 0x1950, 0x19C8,
    0x1A7C, 0x1AF4, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF,
};

void soundfx_play(soundfx_t *sfx, int tune) {
    printf("soundfx_play tune: %d \n", tune);
    sfx->tune_idx = tune;
    sfx->tune_offset = 0;
    SDL_PauseAudioDevice(g_audio_dev, 0);
}

void soundfx_stop(soundfx_t *sfx) {
    printf("soundfx stop \n");
    SDL_PauseAudioDevice(g_audio_dev, 1);
}

void game_audio_callback(void *data, uint8_t* stream, int len) {
    soundfx_t *sfx = (soundfx_t *)data;

    printf("audio callback len: %d , tune: %d \n", len, sfx->tune_idx);
    if (sfx->tune_offset <= sfx->tunes[sfx->tune_idx].sz) {
        printf("Playing tune: %d, offset: %d out of %lu \n", sfx->tune_idx, sfx->tune_offset,
                sfx->tunes[sfx->tune_idx].sz);
        memcpy(stream, &sfx->tunes[sfx->tune_idx].raw[sfx->tune_offset], 4096);
        sfx->tune_offset += len;
    }
    else {
        SDL_PauseAudioDevice(g_audio_dev, 1);
    }
    return;
}

soundfx_t* soundfx_create() {
    soundfx_t *sfx = malloc(sizeof(soundfx_t));
    SDL_AudioSpec audio_spec_want, audio_spec;

    strcpy(sfx->tunes[0].name, "silence");
    sfx->tunes[0].raw = malloc(4096 * 4);
    memset(sfx->tunes[0].raw, 0x00, 4096 * 4);
    sfx->tunes[0].sz = 4096 * 4;

    strcpy(sfx->tunes[1].name, "got_trophy");
    sfx->tunes[1].raw = malloc(4096 * 512);
    sfx->tunes[1].sz = invfreq_decode_soundfx(got_trophy, sfx->tunes[1].raw, 4096 * 512);


    sfx->tune_idx = 0;
    sfx->tune_offset = 0;
    sfx->play = &soundfx_play;
    sfx->stop = &soundfx_stop;

    // Init SDL
    audio_spec_want.freq = 44100;
    audio_spec_want.format = AUDIO_S16LSB;
    audio_spec_want.channels = 1;
    audio_spec_want.samples = 4096;
    audio_spec_want.callback = &game_audio_callback;
    audio_spec_want.userdata = (void*)sfx;

    g_audio_dev = SDL_OpenAudioDevice(NULL, 0,
            &audio_spec_want, &audio_spec, SDL_AUDIO_ALLOW_ANY_CHANGE);
    if (g_audio_dev == 0) {
        printf("Failed to open audio device \n");
        return NULL;
    }
    SDL_PauseAudioDevice(g_audio_dev, 1);

    return sfx;
}

void soundfx_destroy(soundfx_t *sfx)
{
    SDL_CloseAudioDevice(g_audio_dev);
}
